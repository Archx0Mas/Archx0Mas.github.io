<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLogaritesi i Qeras - Llogarit ROI-n e Qerase</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #4338ca;
            --primary-light: #e0e7ff;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --accent: #10b981; 
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* LAYOUT */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
        }

        /* TITLE STYLES */
        .main-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }
        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin: 0;
            background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
        }
        .main-header p {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin: 8px 0 0 0;
        }

        /* DISCLAIMER BOX STYLES */
        .disclaimer-box {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .disclaimer-box svg {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            color: #f59e0b;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .card {
            background: var(--surface);
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .sticky-sidebar { position: sticky; top: 20px; }

        h2 { margin: 0 0 20px 0; color: var(--text-main); font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        h2 i { color: var(--primary); }
        h3 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 25px 0 10px 0; }

        /* INPUTS */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-wrapper { margin-bottom: 5px; }
        
        label { 
            display: flex; 
            justify-content: flex-start; 
            align-items: center;
            gap: 8px; 
            font-size: 0.85em; 
            font-weight: 600; 
            margin-bottom: 6px; 
            color: var(--text-muted); 
            position: relative; 
        }

        .input-icon-group { position: relative; display: flex; align-items: center; }
        .input-icon-group i { position: absolute; left: 12px; color: #94a3b8; font-size: 0.9em; pointer-events: none; z-index: 2; }

        /* INPUT & SELECT STYLING - Fixed padding for Select */
        input[type="number"], select {
            width: 100%;
            padding: 12px 12px 12px 40px; /* Increased padding-left to clear the icon */
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: #f8fafc;
            font-weight: 500;
            box-sizing: border-box;
            appearance: none; /* Removes default browser arrow */
            -webkit-appearance: none;
        }
        
        /* Custom arrow for select */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px; /* Space for the arrow */
            cursor: pointer;
        }

        input:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px var(--primary-light); }

        .toggle-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-light);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c7d2fe;
        }
        .toggle-label { font-weight: 600; color: var(--primary); margin: 0; font-size: 0.95rem;}
        input[type="checkbox"] { accent-color: var(--primary); transform: scale(1.2); cursor: pointer; }

        #mortgageSection { 
            transition: all 0.4s ease-in-out; 
            max-height: 500px; 
            opacity: 1; 
            overflow: hidden; 
        }
        #mortgageSection.hidden { 
            max-height: 0; 
            opacity: 0; 
            margin: 0; 
            overflow: hidden !important; 
        }
        #mortgageSection.visible-overflow {
            overflow: visible;
        }

        /* RESULTS */
        .results-header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #e2e8f0; }
        .big-number { font-size: 2.5rem; font-weight: 800; color: var(--text-main); letter-spacing: -1px; line-height: 1; }
        .big-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; margin-top: 5px; }

        .wealth-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
        }
        .wealth-box .big-number { color: white; }
        .wealth-box .big-label { color: #d1fae5; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #f1f5f9; padding: 12px; border-radius: 8px; text-align: center; }
       
        .breakdown-row { display: flex; justify-content: space-between; font-size: 0.9rem; padding: 8px 0; border-bottom: 1px solid #f1f5f9; color: var(--text-muted); }
        .breakdown-row strong { color: var(--text-main); }
        .breakdown-row.total { border-top: 2px solid #e2e8f0; border-bottom: none; padding-top: 12px; margin-top: 5px; color: var(--text-main); font-weight: 700; }

        .calc-btn { width: 100%; background: var(--text-main); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.1s; }
        .calc-btn:active { transform: scale(0.98); }

        .chart-wrapper { height: 250px; width: 100%; position: relative; margin-top: 15px; }

        /* TOOLTIP STYLES */
        .tooltip {
            position: relative;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: var(--primary);
            width: 20px; 
            height: 20px;
            z-index: 10;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 9999;
            bottom: 135%; 
            left: 50%;
            margin-left: -100px; 
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            line-height: 1.4;
            font-weight: 400;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            pointer-events: none;
        }

        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip.active .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 600px) {
            .tooltip .tooltip-text {
                width: 180px;
                margin-left: -90px;
            }
        }
    </style>
</head>
<body>


<div class="app-container">
   
    <div class="input-column">
        
        <div class="main-header">
            <h1>LLogaritesi i te Ardhurave te Qeras</h1>
            <p>Llogaritni fitimin mujor nga qeraja, fitimin vjetor neto te qeras dhe projektimin e rritjes se qeras per 30 vjet. Vereni: R.O.I do te thote kthimi nga investimi (Return On Investment).</p>
        </div>

        <div class="disclaimer-box">
            <svg fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            <div>
                <strong>Kujdes:</strong> Rezultatet e kÃ«tij kalkulatori janÃ« vetÃ«m pÃ«r orientim. Kostot aktuale, normat e interesit dhe kushtet mund tÃ« ndryshojnÃ« nga banka nÃ« bankÃ« nese merni nje prone me kredi. Kontaktoni institucionin tuaj financiar pÃ«r oferta tÃ« sakta dhe tÃ« personalizuara.
            </div>
        </div>

        <div class="card" style="padding: 15px; display: flex; align-items: center; justify-content: space-between;">
            <label style="margin:0; font-size: 1rem; color: var(--primary); font-weight: 700; cursor:pointer; width: auto;" for="currencySelector">
                <span><i class="fas fa-globe"></i> Zgjidh Monedhen </span>
            </label>
            <div style="width: 200px;">
                <select id="currencySelector" onchange="calculate()">
                    <option value="USD">ðŸ‡ºðŸ‡¸ Dollar ($)</option>
                    <option value="EUR">ðŸ‡ªðŸ‡º Euro (â‚¬)</option>
                    <option value="GBP">ðŸ‡¬ðŸ‡§ Pound (Â£)</option>
                    <option value="ALL">ðŸ‡¦ðŸ‡± Albanian Lek (ALL)</option>
                </select>
            </div>
        </div>
       
        <div class="card">
            <h2><i class="fas fa-home"></i> Prona </h2>
            <div class="input-grid">
                <div class="input-wrapper">
                    <label>
                        Vlera e Prones
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos shumen totale te vleres se prones.</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-tag"></i>
                        <input type="number" id="price" value="0">
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>
                        Kosto e Mbylljes
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Pagesa Totale e Transaksionit te Prones (Noteri, Taks, Agjenci).</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-file-signature"></i>
                        <input type="number" id="closingCosts" value="0">
                    </div>
                </div>
            </div>

            <div class="toggle-box" style="margin-top: 15px;">
                <span class="toggle-label"><i class="fas fa-money-bill-wave"></i> E Blet te Gjith Pronen ne cash? Nese po, selekto kutin! </span>
                <input type="checkbox" id="cashPurchase" onchange="toggleMortgageInputs()">
            </div>

            <div id="mortgageSection">
                <div class="input-grid">
                    <div class="input-wrapper">
                        <label>
                             Parapagim (%)
                            <div class="tooltip" onclick="toggleTooltip(this, event)">
                                <i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">Vendos shumen ne perqindje qÃ« do tÃ« paguani nga xhepi juaj (jo kredi). Bankat zakonisht kÃ«rkojnÃ« 15-20% paradhÃ«nie pÃ«r hipotekÃ«. MÃ« shumÃ« paradhÃ«nie = normÃ« mÃ« e mirÃ«.</span>
                            </div>
                        </label>
                        <div class="input-icon-group">
                            <i class="fas fa-percentage"></i>
                            <input type="number" id="downPaymentPercent" value="0">
                        </div>
                    </div>
                    <div class="input-wrapper">
                        <label>
                            Norma e Interesit Vjetor (%)
                            <div class="tooltip" onclick="toggleTooltip(this, event)">
                                <i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">Vendos normen NOMINALE vjetore te interesit qÃ« banka ofron (p.sh. 8.5%). Kjo Ã«shtÃ« vetÃ«m interesi - NEI (norma efektive) do tÃ« jetÃ« mÃ« e lartÃ« sepse pÃ«rfshin tarifat. NÃ« ShqipÃ«ri: ALL 7-10%, EUR 4-7%.</span>
                            </div>
                        </label>
                        <div class="input-icon-group">
                            <i class="fas fa-percentage"></i>
                            <input type="number" id="interestRate" value="0" step="0.1">
                        </div>
                    </div>
                </div>
                <div class="input-wrapper" style="margin-top: 15px;">
                    <label>
                         PÃ«rcakto KohÃ«n e Kredis (Vite)
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos afatin nÃ« vite te kredis (p.sh. 20).</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-calendar"></i>
                        <input type="number" id="loanTerm" value="0">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-wallet"></i> Te Ardhurat & Shpenzimet </h2>
            <div class="input-grid">
                <div class="input-wrapper">
                    <label>
                        Te Ardhurat Mujore Te Qeras
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos shumen mujore te paras qe merni nga dhenia me qera e prones.</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-hand-holding-dollar"></i>
                        <input type="number" id="rent" value="0">
                    </div>
                </div>
            </div>

            <h3>Shpenzimet Vjetore</h3>
            <div class="input-grid">
                <div class="input-wrapper">
                    <label>
                         Taksa e Prones
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Zgjidh tasken e duhur vjetore ne baz te llojit te prones (per resident = taksa 0.05%).</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-file-invoice"></i>
                        <select id="taxType" onchange="calculate()">
                            <option value="0.05">Resident (0.05%)</option>
                            <option value="0.15">Industri & Bujqesi (0.15%)</option>
                            <option value="0.15">Tregtare (0.15%)</option>
                        </select>
                    </div>
                </div>

                <div class="input-wrapper">
                    <label>
                         Sigurimi i Prones
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos koston totale vjetore te sigurimit te prones. Pagesa varet nga zona ku ndodhet prona dhe nga madhesia e prones.</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-shield-alt"></i>
                        <input type="number" id="annualInsurance" value="0">
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>
                        Riparimet (%)
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos sa % e paras qe fiton nga qeraja te shkon per rregullime te prones.</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-tools"></i>
                        <input type="number" id="maintenanceRate" value="0">
                    </div>
                </div>
                 <div class="input-wrapper">
                    <label>
                         Tatim Fitimi (%)
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos sa % te taton shteti per te ardhurat nga qeraja ne vit. Ne Shqiperi eshte 15%.</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-user-tie"></i>
                        <input type="number" id="incomeTaxRate" value="0">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-chart-line"></i>  Rritja e Qerase </h2>
            <div class="input-grid">
                <div class="input-wrapper">
                    <label>
                        Norma Vjetore e Rritjes se Qerase (%)
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos sa % ne vit mund te rritet qeraja juaj. Norma Baze e rritjes esht 3%.</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-arrow-up"></i>
                        <input type="number" id="rentIncrease" value="0" step="0.1">
                    </div>
                </div>
                <div class="input-wrapper">
                    <label>
                        Norma Vjetore e Rritjes se Vleres se Prones (%)
                        <div class="tooltip" onclick="toggleTooltip(this, event)">
                            <i class="fas fa-question-circle"></i>
                            <span class="tooltip-text">Vendos sa % ne vit mund te rritet vlera e prones tuaj.</span>
                        </div>
                    </label>
                    <div class="input-icon-group">
                        <i class="fas fa-chart-bar"></i>
                        <input type="number" id="appreciationRate" value="0" step="0.1">
                    </div>
                </div>
            </div>
            <button class="calc-btn" onclick="calculate()">LLogarit R.O.I e Qerase</button>
        </div>

    </div>

    <div class="sticky-sidebar">
        <div class="card">
            <div class="results-header">
                <span class="big-number" id="monthlyCashFlow">$0</span>
                <div class="big-label">Te Ardhurat Mujore Neto</div>
            </div>

            <div class="wealth-box">
                <div class="big-number" id="annualProfitNet">$0</div>
                <div class="big-label">Te Ardhurat Vjetore Neto</div>
            </div>

            <div class="stat-grid">
                <div class="stat-box">
                    <div id="cocRoi" style="font-weight: 800; color: var(--primary);">0%</div>
                    <div style="font-size: 0.7em; color: #64748b;">Cash on Cash ROI</div>
                </div>
                <div class="stat-box">
                    <div id="capRate" style="font-weight: 800; color: var(--primary);">0%</div>
                    <div style="font-size: 0.7em; color: #64748b;">Cap Rate</div>
                </div>
            </div>

            <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                <div class="breakdown-row"><span>Kostoja Mujore e Kredise</span><strong id="piPayment">$0</strong></div>
                <div class="breakdown-row"><span>Kostoja e Takses se Prones & Sigurimit</span><strong id="taxInsPayment">$0</strong></div>
                <div class="breakdown-row"><span>Kostoja e Riparimeve te Prones</span><strong id="vacMaintPayment">$0</strong></div>
                <div class="breakdown-row"><span>Tatim Fitimi</span><strong id="incTaxPayment" style="color:var(--primary);">$0</strong></div>
                <div class="breakdown-row total"><span>Kostoja Mujore ne Total</span><strong id="totalExpenses">$0</strong></div>
            </div>
           
            <h3 style="margin-top: 20px;">Grafiku i Te Ardhurave & Shpenzimeve</h3>
            <div class="chart-wrapper" style="height: 150px;">
                <canvas id="donutChart"></canvas>
            </div>

            <h3 style="margin-top: 20px;">Te Ardhurat Vjetore Neto (Vit pas Viti)</h3>
            <div class="chart-wrapper">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
    let donutChart = null; 
    let lineChart = null;
    let animationTimeout = null;

    window.onload = function() {
        document.getElementById('cashPurchase').checked = false;
        toggleMortgageInputs();
        calculate();
        setupTooltipListeners();
    }

    // --- TOOLTIP LOGIC ---
    function toggleTooltip(element, event) {
        event.preventDefault(); 
        event.stopPropagation();
        
        const allTooltips = document.querySelectorAll('.tooltip');
        allTooltips.forEach(t => {
            if (t !== element) t.classList.remove('active');
        });

        element.classList.toggle('active');
    }

    function setupTooltipListeners() {
        document.addEventListener('click', function(e) {
            const allTooltips = document.querySelectorAll('.tooltip');
            allTooltips.forEach(t => t.classList.remove('active'));
        });
    }

    // --- SECTION ANIMATION LOGIC ---
    function toggleMortgageInputs() {
        const isCash = document.getElementById('cashPurchase').checked;
        const section = document.getElementById('mortgageSection');
        
        if (animationTimeout) clearTimeout(animationTimeout);

        if (isCash) {
            section.classList.remove('visible-overflow'); 
            section.classList.add('hidden');
        } else {
            section.classList.remove('hidden');
            animationTimeout = setTimeout(() => {
                section.classList.add('visible-overflow');
            }, 400); 
        }
        calculate();
    }

    function calculate() {
        // --- CURRENCY ---
        const currencyCode = document.getElementById('currencySelector').value;
        const fmt = (n) => n.toLocaleString('en-US', { style: 'currency', currency: currencyCode, maximumFractionDigits: 0 });

        // --- INPUTS ---
        const price = parseFloat(document.getElementById('price').value) || 0;
        const closingCosts = parseFloat(document.getElementById('closingCosts').value) || 0;
        const isCash = document.getElementById('cashPurchase').checked;
       
        // NEW TAX LOGIC
        const taxRate = parseFloat(document.getElementById('taxType').value) || 0;
        const annualPropTax = price * (taxRate / 100);

        const annualInsurance = parseFloat(document.getElementById('annualInsurance').value) || 0;
       
        const rawRent = parseFloat(document.getElementById('rent').value) || 0;
        const vacancyRate = 0; 

        const maintenanceRate = parseFloat(document.getElementById('maintenanceRate').value) || 0;
        const incomeTaxRate = parseFloat(document.getElementById('incomeTaxRate').value) || 0;
        
        const rentGrowth = parseFloat(document.getElementById('rentIncrease').value) || 0;
        const appreciationRate = parseFloat(document.getElementById('appreciationRate').value) || 0;

        // --- ACQUISITION ---
        let downPayment = price; 
        let mortgagePayment = 0;
        let loanAmount = 0;
        let monthlyInterestRate = 0;

        if (!isCash) {
            const downPercent = parseFloat(document.getElementById('downPaymentPercent').value) || 0;
            downPayment = price * (downPercent / 100);
            loanAmount = price - downPayment;
           
            const rate = parseFloat(document.getElementById('interestRate').value) || 0;
            const years = parseFloat(document.getElementById('loanTerm').value) || 0;
           
            if (rate > 0 && years > 0) {
                monthlyInterestRate = (rate / 100) / 12;
                const numberOfPayments = years * 12;
                mortgagePayment = (loanAmount * monthlyInterestRate) / (1 - Math.pow(1 + monthlyInterestRate, -numberOfPayments));
            }
        }

        const totalInitialInvestment = downPayment + closingCosts;

        // --- YEAR 1 OPERATIONS (MONTHLY) ---
        const vacancyCost = rawRent * (vacancyRate / 100);
        const effectiveRent = rawRent - vacancyCost; 
       
        const maintenanceCost = effectiveRent * (maintenanceRate / 100);
        const taxCost = annualPropTax / 12;
        const insCost = annualInsurance / 12;

        const operatingExpenses = taxCost + insCost + maintenanceCost;
        const noi = effectiveRent - operatingExpenses;

        const preTaxCashFlow = noi - mortgagePayment;

        let incomeTaxCost = 0;
        if (preTaxCashFlow > 0) {
            incomeTaxCost = preTaxCashFlow * (incomeTaxRate / 100);
        }

        const netCashFlow = preTaxCashFlow - incomeTaxCost;
        const totalOutflow = mortgagePayment + operatingExpenses + incomeTaxCost + vacancyCost;

        // --- METRICS ---
        const annualCashFlow = netCashFlow * 12;
        const annualNOI = noi * 12;
        const capRate = price > 0 ? (annualNOI / price) * 100 : 0;
        const cocRoi = totalInitialInvestment > 0 ? (annualCashFlow / totalInitialInvestment) * 100 : 0;

        // --- UI UPDATES ---
        const cfEl = document.getElementById('monthlyCashFlow');
        cfEl.innerText = fmt(netCashFlow);
        cfEl.style.color = netCashFlow >= 0 ? 'var(--accent)' : 'var(--danger)';

        document.getElementById('annualProfitNet').innerText = fmt(annualCashFlow);
        document.getElementById('cocRoi').innerText = cocRoi.toFixed(2) + '%';
        document.getElementById('capRate').innerText = capRate.toFixed(2) + '%';

        document.getElementById('piPayment').innerText = fmt(mortgagePayment);
        document.getElementById('taxInsPayment').innerText = fmt(taxCost + insCost);
        document.getElementById('vacMaintPayment').innerText = fmt(vacancyCost + maintenanceCost);
        document.getElementById('incTaxPayment').innerText = fmt(incomeTaxCost);
        document.getElementById('totalExpenses').innerText = fmt(totalOutflow);

        updateDonut(mortgagePayment, taxCost+insCost, vacancyCost+maintenanceCost, incomeTaxCost, netCashFlow);
       
        updateProjection(
            price,
            loanAmount,
            monthlyInterestRate,
            mortgagePayment,
            rawRent, 
            annualPropTax, 
            annualInsurance, 
            vacancyRate, 
            maintenanceRate, 
            incomeTaxRate, 
            rentGrowth,
            appreciationRate,
            currencyCode
        );
    }

    function updateDonut(mortgage, fixedOps, variableOps, tax, profit) {
        const ctx = document.getElementById('donutChart').getContext('2d');
        if (donutChart) donutChart.destroy();

        let safeProfit = profit > 0 ? profit : 0;

        donutChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Kredia', 'Taksa & Sigurimi', 'Riparimet', 'Tatim Fitimi', 'Fitimi'],
                datasets: [{
                    data: [mortgage, fixedOps, variableOps, tax, safeProfit],
                    backgroundColor: ['#4338ca', '#f59e0b', '#64748b', '#a855f7', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- STACKED BAR CHART: CASH FLOW vs EQUITY vs APPRECIATION ---
    function updateProjection(
        startPrice,
        startLoanBalance,
        monthlyInterestRate,
        fixedMortgagePayment,
        startRent, 
        startTax, 
        startIns, 
        vacRate, 
        maintRate, 
        taxRate, 
        rentGrowth, 
        appreciationRate,
        currencyCode
    ) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        if (lineChart) lineChart.destroy();

        const labels = [];
        const cashFlowData = [];
        const equityData = [];
        const appreciationData = [];
       
        let currentTax = startTax / 12; 
        let currentIns = startIns / 12; 
        const annualRentIncreaseAmount = startRent * (rentGrowth / 100);
        
        let currentLoanBalance = startLoanBalance;
        let currentPropertyValue = startPrice;

        for (let i = 1; i <= 30; i++) {
            labels.push(`Viti ${i}`);
            
            // 1. Calculate Annual Cash Flow
            let monthlyRent = startRent + (annualRentIncreaseAmount * (i - 1));
            let annualRent = monthlyRent * 12;
            let vacancyLoss = annualRent * (vacRate/100);
            let effectiveAnnualRent = annualRent - vacancyLoss;
            let annualMaint = effectiveAnnualRent * (maintRate/100);
            let annualFixedOps = (currentTax * 12) + (currentIns * 12);
            let annualMortgage = fixedMortgagePayment * 12;
           
            let preTaxProfit = effectiveAnnualRent - annualFixedOps - annualMaint - annualMortgage;
            let taxBill = 0;
            if (preTaxProfit > 0) {
                taxBill = preTaxProfit * (taxRate / 100);
            }
            let netAnnualCashFlow = preTaxProfit - taxBill;

            // 2. Calculate Principal Paydown (Equity)
            let annualPrincipalPaid = 0;
            if (currentLoanBalance > 0) {
                for (let m = 0; m < 12; m++) {
                    if (currentLoanBalance <= 0) break;
                    let interestPayment = currentLoanBalance * monthlyInterestRate;
                    let principalPayment = fixedMortgagePayment - interestPayment;
                    if (principalPayment > currentLoanBalance) principalPayment = currentLoanBalance;
                    
                    annualPrincipalPaid += principalPayment;
                    currentLoanBalance -= principalPayment;
                }
            }

            // 3. Calculate Appreciation
            let appreciationAmount = currentPropertyValue * (appreciationRate / 100);
            currentPropertyValue += appreciationAmount;

            // Push specific segments to arrays
            cashFlowData.push(netAnnualCashFlow > 0 ? netAnnualCashFlow : 0);
            equityData.push(annualPrincipalPaid);
            appreciationData.push(appreciationAmount);
        }

        lineChart = new Chart(ctx, {
            type: 'bar', 
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Te Ardhurat Vjetore',
                        data: cashFlowData,
                        backgroundColor: '#10b981', // Green
                        stack: 'Stack 0',
                    },
                    {
                        label: 'Ndertim Asetesh',
                        data: equityData,
                        backgroundColor: '#4338ca', // Blue
                        stack: 'Stack 0',
                    },
                    {
                        label: 'Vlersimi i Prones',
                        data: appreciationData,
                        backgroundColor: '#f59e0b', // Amber/Orange
                        borderRadius: 4, // Round top only
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: { 
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: { boxWidth: 12, font: { size: 10 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('en-US', { style: 'currency', currency: currencyCode, maximumFractionDigits: 0 }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        stacked: true,
                        beginAtZero: true,
                        ticks: { 
                            callback: (val) => {
                                const symbol = (0).toLocaleString('en-US', { style: 'currency', currency: currencyCode }).replace(/0.00|0/g, '').trim();
                                return symbol + (val/1000) + 'k';
                            } 
                        },
                        grid: { borderDash: [5, 5] }
                    },
                    x: { 
                        stacked: true,
                        grid: { display: false }, 
                        ticks: { maxTicksLimit: 10 } 
                    }
                }
            }
        });
    }
</script>

</body>
</html>
